name: Update and Build CoreDNS Plus

on:
  schedule:
    - cron: '0 0 * * *'  # Run daily to check for updates
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22.x'  # Use a recent Go version compatible with CoreDNS

      - name: Get latest CoreDNS release version
        id: get_version
        run: |
          LATEST_TAG=$(curl -sL https://api.github.com/repos/coredns/coredns/releases/latest | jq -r '.tag_name')
          echo "latest_version=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: Check if update is needed
        id: check_update
        run: |
          if [ -f VERSION ]; then
            CURRENT=$(cat VERSION)
            if [ "\( CURRENT" != " \){{ steps.get_version.outputs.latest_version }}" ]; then
              echo "update_needed=true" >> $GITHUB_OUTPUT
            else
              echo "update_needed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "update_needed=true" >> $GITHUB_OUTPUT
          fi

      - name: Clone CoreDNS source if update needed
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          git clone https://github.com/coredns/coredns.git --depth 1 --branch ${{ steps.get_version.outputs.latest_version }} coredns-src

      - name: Add third-party plugins to plugin.cfg
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          cd coredns-src
          # Add blocklist plugin for ad blocking (supports remote loading)
          echo "blocklist:github.com/relekang/coredns-blocklist" >> plugin.cfg
          # Add git plugin for remote git zone loading
          echo "git:github.com/miekg/coredns-git" >> plugin.cfg
          # Add redis plugin for remote redis backend
          echo "redis:github.com/codysnider/coredns-redis" >> plugin.cfg
          # Add mysql plugin for remote mysql backend
          echo "mysql:github.com/cloud66-oss/coredns_mysql" >> plugin.cfg
          # Add netbox plugin for remote netbox api
          echo "netbox:github.com/oz123/coredns-netbox-plugin" >> plugin.cfg

      - name: Fetch dependencies for plugins
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          cd coredns-src
          go get github.com/re
