name: Build CoreDNS Plus (arm64 with extra plugins)

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write           # 必須設置為 write 才能 push 編譯好的文件和 tag

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0    # 完整拉取，確保 git push 順暢

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true       # 開啟 Go 快取，加速後續建置

      - name: Check for CoreDNS upstream update
        id: check-update
        run: |
          LATEST_TAG=$(curl -s https://api.github.com/repos/coredns/coredns/releases/latest | jq -r '.tag_name')
          echo "Latest upstream CoreDNS tag: $LATEST_TAG"
          
          CURRENT_TAG="none"
          if [ -f current_tag.txt ]; then
            CURRENT_TAG=$(cat current_tag.txt)
          fi

          if [ "$CURRENT_TAG" = "$LATEST_TAG" ]; then
            echo "update_needed=false" >> $GITHUB_OUTPUT
          else
            echo "update_needed=true" >> $GITHUB_OUTPUT
            echo "new_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          fi

      - name: Build CoreDNS + plugins (Linux arm64)
        if: steps.check-update.outputs.update_needed == 'true'
        run: |
          NEW_TAG=${{ steps.check-update.outputs.new_tag }}
          
          # 使用 HTTPS Clone 避開 SSH Key 問題
          git clone --depth 1 --branch $NEW_TAG https://github.com/coredns/coredns.git coredns_source
          cd coredns_source

          # 修改 plugin.cfg
          # 注意：CoreDNS 插件順序很重要，通常放在 hosts 之後
          # 這裡使用暫存檔來確保格式正確
          sed -i '/hosts:hosts/a \
          blocker:github.com/GustavoKatel/coredns-blocker\
          block:github.com/spr-networks/coredns-block\
          blocklist:github.com/relekang/coredns-blocklist\
          filter:github.com/wranders/coredns-filter\
          finalizer:github.com/tmeckel/coredns-finalizer\
          geoip:github.com/miekg/geoip\
          rpzd:github.com/coredns/rpzd' plugin.cfg

          # 更新 go.mod 並下載依賴
          go generate
          go get github.com/GustavoKatel/coredns-blocker@latest
          go get github.com/spr-networks/coredns-block@latest
          go get github.com/relekang/coredns-blocklist@latest
          go get github.com/wranders/coredns-filter@latest
          go get github.com/tmeckel/coredns-finalizer@latest
          go get github.com/miekg/geoip@latest
          go get github.com/coredns/rpzd@latest
          go mod tidy

          # 編譯 arm64
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 \
            go build -v -ldflags="-s -w -X github.com/coredns/coredns/coremain.GitCommit=$NEW_TAG" -o ../coredns-arm64

          cd ..
          echo "$NEW_TAG" > current_tag.txt

      - name: Commit and push changes
        if: steps.check-update.outputs.update_needed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git add coredns-arm64 current_tag.txt
          git commit -m "chore: update to CoreDNS ${{ steps.check-update.outputs.new_tag }} (arm64)"
          git push
