name: Update and Build CoreDNS Plus

on:
  schedule:
    - cron: '0 0 * * *'  # Run daily to check for updates
  workflow_dispatch:     # Allow manual trigger

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22.x'  # Use a recent Go version compatible with CoreDNS

      - name: Get latest CoreDNS release version
        id: get_version
        run: |
          LATEST_TAG=$(curl -sL https://api.github.com/repos/coredns/coredns/releases/latest | jq -r '.tag_name')
          echo "latest_version=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: Check if update is needed
        id: check_update
        run: |
          if [ -f VERSION ]; then
            CURRENT=$(cat VERSION)
            if [ "\( CURRENT" != " \){{ steps.get_version.outputs.latest_version }}" ]; then
              echo "update_needed=true" >> $GITHUB_OUTPUT
            else
              echo "update_needed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "update_needed=true" >> $GITHUB_OUTPUT
          fi

      - name: Clone CoreDNS source if update needed
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          git clone https://github.com/coredns/coredns.git --depth 1 --branch ${{ steps.get_version.outputs.latest_version }} coredns-src

      # 无需安装 libunbound-dev 等（因为不加 unbound 插件）

      - name: Add third-party plugins to plugin.cfg (防重复添加)
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          cd coredns-src
          grep -q "^blocklist:" plugin.cfg || echo "blocklist:github.com/relekang/coredns-blocklist" >> plugin.cfg
          grep -q "^finalize:" plugin.cfg || echo "finalize:github.com/tmeckel/coredns-finalizer" >> plugin.cfg
          grep -q "^mysql:" plugin.cfg || echo "mysql:github.com/cloud66-oss/coredns_mysql" >> plugin.cfg
          # unbound 已移除（兼容性太差，6年未维护）
          # grep -q "^unbound:" plugin.cfg || echo "unbound:github.com/coredns/unbound" >> plugin.cfg
          grep -q "^git:" plugin.cfg || echo "git:github.com/miekg/coredns-git" >> plugin.cfg

      - name: Generate and tidy modules
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          cd coredns-src
          go generate
          go mod tidy

      - name: Build CoreDNS for Linux arm64 (no cgo needed)
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          cd coredns-src
          # unbound 已移除，可用 CGO_ENABLED=0 保持静态二进制
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -o ../corednsplus

      - name: Move binary to root and update VERSION
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          # mv ../corednsplus .   # 移到仓库根目录
          echo "${{ steps.get_version.outputs.latest_version }}" > VERSION

      - name: Commit and push changes with Git LFS
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          # 确保 LFS 已初始化（预装了也会安全运行）
          git lfs install --force || true   # --force 覆盖旧 hooks，|| true 忽略已存在警告

          # 如果你担心 LFS 未生效，可加这一行检查（可选，调试用）
          git lfs version && git lfs env

          git add corednsplus VERSION

          git commit -m "Update CoreDNS Plus to ${{ steps.get_version.outputs.latest_version }} with plugins (no unbound)" || echo "No changes to commit"

          # Push 时 Git 会自动处理 LFS 对象上传（前提是 .gitattributes 已配置）
          git push
