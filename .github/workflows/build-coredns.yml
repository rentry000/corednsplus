name: Update and Build CoreDNS Plus

on:
  schedule:
    - cron: '0 0 * * *'  # Run daily to check for updates
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22.x'  # Use a recent Go version compatible with CoreDNS

      - name: Get latest CoreDNS release version
        id: get_version
        run: |
          LATEST_TAG=$(curl -sL https://api.github.com/repos/coredns/coredns/releases/latest | jq -r '.tag_name')
          echo "latest_version=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: Check if update is needed
        id: check_update
        run: |
          if [ -f VERSION ]; then
            CURRENT=$(cat VERSION)
            if [ "\( CURRENT" != " \){{ steps.get_version.outputs.latest_version }}" ]; then
              echo "update_needed=true" >> $GITHUB_OUTPUT
            else
              echo "update_needed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "update_needed=true" >> $GITHUB_OUTPUT
          fi

      - name: Clone CoreDNS source if update needed
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          git clone https://github.com/coredns/coredns.git --depth 1 --branch ${{ steps.get_version.outputs.latest_version }} coredns-src

      - name: Add third-party plugins to plugin.cfg
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          cd coredns-src
          # Add adblock plugin using a version with go.mod
          echo "blocker:github.com/GustavoKatel/coredns-blocker" >> plugin.cfg
          # Skip git plugin as repository is not publicly available; consider alternatives if needed

      - name: Fetch dependencies for plugins
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          cd coredns-src
          go get github.com/GustavoKatel/coredns-blocker
          go mod tidy

      - name: Build CoreDNS for Linux arm64
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          cd coredns-src
          go generate
          GOOS=linux GOARCH=arm64 go build -o ../corednsplus

      - name: Move binary to root and update VERSION
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          mv corednsplus ./
          echo "${{ steps.get_version.outputs.latest_version }}" > VERSION

      - name: Commit and push changes
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add corednsplus VERSION
          git commit -m "Update CoreDNS Plus to ${{ steps.get_version.outputs.latest_version }} with plugins"
          git push
