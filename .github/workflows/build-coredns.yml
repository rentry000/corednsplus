name: Update and Build CoreDNS Plus

on:
  schedule:
    - cron: '0 0 * * *'  # Run daily to check for updates
  workflow_dispatch:     # Allow manual trigger

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22.x'  # Use a recent Go version compatible with CoreDNS

      - name: Get latest CoreDNS release version
        id: get_version
        run: |
          LATEST_TAG=$(curl -sL https://api.github.com/repos/coredns/coredns/releases/latest | jq -r '.tag_name')
          echo "latest_version=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: Check if update is needed
        id: check_update
        run: |
          if [ -f VERSION ]; then
            CURRENT=$(cat VERSION)
            if [ "\( CURRENT" != " \){{ steps.get_version.outputs.latest_version }}" ]; then
              echo "update_needed=true" >> $GITHUB_OUTPUT
            else
              echo "update_needed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "update_needed=true" >> $GITHUB_OUTPUT
          fi

      - name: Clone CoreDNS source if update needed
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          git clone https://github.com/coredns/coredns.git --depth 1 --branch ${{ steps.get_version.outputs.latest_version }} coredns-src

      - name: Install dependencies for unbound plugin (cgo + libunbound)
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          sudo apt update
          sudo apt install -y libunbound-dev pkg-config build-essential

      - name: Add third-party plugins to plugin.cfg (防重复添加)
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          cd coredns-src
          grep -q "^blocklist:" plugin.cfg || echo "blocklist:github.com/relekang/coredns-blocklist" >> plugin.cfg
          grep -q "^finalize:" plugin.cfg || echo "finalize:github.com/tmeckel/coredns-finalizer" >> plugin.cfg
          # unbound 已 archived 6 年，兼容性风险高，建议注释掉或移除
          # grep -q "^unbound:" plugin.cfg || echo "unbound:github.com/coredns/unbound" >> plugin.cfg
          grep -q "^git:" plugin.cfg || echo "git:github.com/miekg/coredns-git" >> plugin.cfg

      - name: Generate and tidy modules
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          cd coredns-src
          go generate
          go mod tidy

      - name: Build CoreDNS for Linux arm64
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          cd coredns-src
          # unbound 需要 CGO_ENABLED=1；如果注释掉 unbound 可改为 CGO_ENABLED=0（静态二进制）
          CGO_ENABLED=1 GOOS=linux GOARCH=arm64 go build -o ../corednsplus

      - name: Move binary to root and update VERSION
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          mv ../corednsplus .   # 移到仓库根目录（可选，根据你的 commit 需要）
          echo "${{ steps.get_version.outputs.latest_version }}" > VERSION

      - name: Commit and push changes
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add corednsplus VERSION
          git commit -m "Update CoreDNS Plus to ${{ steps.get_version.outputs.latest_version }} with plugins" || echo "No changes to commit"
          git push
