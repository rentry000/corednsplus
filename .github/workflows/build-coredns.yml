name: Build CoreDNS Plus

on:
  schedule:
    - cron: '0 0 * * *'  # 每天 UTC 00:00 检查一次（可调整为更频繁）
  workflow_dispatch:     # 支持手动触发

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}  # 使用 PAT 以允许 push

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'  # CoreDNS 推荐的 Go 版本（可根据上游更新）

      - name: Check for CoreDNS update
        id: check-update
        run: |
          # 获取上游最新 tag
          LATEST_TAG=$(curl -s https://api.github.com/repos/coredns/coredns/releases/latest | jq -r '.tag_name')
          echo "Latest CoreDNS tag: $LATEST_TAG"
          
          # 检查当前记录的 tag
          if [ -f current_tag.txt ]; then
            CURRENT_TAG=$(cat current_tag.txt)
            if [ "$CURRENT_TAG" == "$LATEST_TAG" ]; then
              echo "No update needed"
              echo "update_needed=false" >> $GITHUB_OUTPUT
            else
              echo "Update available: from $CURRENT_TAG to $LATEST_TAG"
              echo "update_needed=true" >> $GITHUB_OUTPUT
              echo "new_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
            fi
          else
            echo "First run or no tag file, forcing build"
            echo "update_needed=true" >> $GITHUB_OUTPUT
            echo "new_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          fi

      - name: Build if update needed
        if: steps.check-update.outputs.update_needed == 'true'
        run: |
          NEW_TAG=${{ steps.check-update.outputs.new_tag }}
          
          # Clone 指定 tag 的 CoreDNS
          git clone --depth 1 --branch $NEW_TAG https://github.com/coredns/coredns.git
          cd coredns
          
          # 获取所有提到的第三方插件
          go get github.com/GustavoKatel/coredns-blocker@latest
          go get github.com/spr-networks/coredns-block@latest
          go get github.com/relekang/coredns-blocklist@latest
          go get github.com/icyflame/blocker@latest
          go get github.com/wranders/coredns-filter@latest
          go get github.com/tmeckel/coredns-finalizer@latest
          go get github.com/miekg/geoip@latest  # 假设 geoip 插件路径
          go get github.com/coredns/rpzd@latest
          
          # 编辑 plugin.cfg：在 hosts:hosts 后插入所有插件（多行以 \ 分隔）
          sed -i '/hosts:hosts/a \
          blocker:github.com/GustavoKatel/coredns-blocker \
          block:github.com/spr-networks/coredns-block \
          blocklist:github.com/relekang/coredns-blocklist \
          blocker:github.com/icyflame/blocker \
          filter:github.com/wranders/coredns-filter \
          finalizer:github.com/tmeckel/coredns-finalizer \
          geoip:github.com/miekg/geoip \
          rpzd:github.com/coredns/rpzd' plugin.cfg
          
          # 生成代码
          go generate
          
          # 构建 Linux arm64 版本
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 \
            go build -ldflags="-s -w -X github.com/coredns/coredns/coremain.GitCommit=$NEW_TAG" -o coredns
          
          # 复制到仓库根目录
          mv coredns ../coredns-arm64
          
          # 更新 tag 记录文件
          echo $NEW_TAG > ../current_tag.txt

      - name: Commit and push changes
        if: steps.check-update.outputs.update_needed == 'true'
        run: |
          NEW_TAG=${{ steps.check-update.outputs.new_tag }}
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add coredns-arm64 current_tag.txt
          git commit -m "Update CoreDNS Plus to $NEW_TAG with all plugins (arm64)"
          git push
