name: Update and Build CoreDNS Plus

on:
  schedule:
    - cron: '0 0 * * *'  # Run daily to check for updates
  workflow_dispatch:     # Allow manual trigger

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22.x'  # Use a recent Go version compatible with CoreDNS

      - name: Get latest CoreDNS release version
        id: get_version
        run: |
          LATEST_TAG=$(curl -sL https://api.github.com/repos/coredns/coredns/releases/latest | jq -r '.tag_name')
          echo "latest_version=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: Check if update is needed
        id: check_update
        run: |
          if [ -f VERSION ]; then
            CURRENT=$(cat VERSION)
            if [ "\( CURRENT" != " \){{ steps.get_version.outputs.latest_version }}" ]; then
              echo "update_needed=true" >> $GITHUB_OUTPUT
            else
              echo "update_needed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "update_needed=true" >> $GITHUB_OUTPUT
          fi

      - name: Clone CoreDNS source if update needed
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          git clone https://github.com/coredns/coredns.git --depth 1 --branch ${{ steps.get_version.outputs.latest_version }} coredns-src

      # 无需安装 libunbound-dev 等（因为不加 unbound 插件）

      - name: Add third-party plugins to plugin.cfg (防重复添加)
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          cd coredns-src
          grep -q "^blocklist:" plugin.cfg || echo "blocklist:github.com/relekang/coredns-blocklist" >> plugin.cfg
          grep -q "^finalize:" plugin.cfg || echo "finalize:github.com/tmeckel/coredns-finalizer" >> plugin.cfg
          grep -q "^mysql:" plugin.cfg || echo "mysql:github.com/cloud66-oss/coredns_mysql" >> plugin.cfg
          grep -q "^carbolicacid:" plugin.cfg || echo "carbolicacid:github.com/PtrBreak/coredns-carbolicacid" >> plugin.cfg
          grep -q "^filter:" plugin.cfg || echo "filter:github.com/milgradesec/filter" >> plugin.cfg
          grep -q "^responsefilter:" plugin.cfg || echo "responsefilter:github.com/isovalent/responsefilter" >> plugin.cfg
          # grep -q "^iplimit:" plugin.cfg || echo "iplimit:github.com/fabiant7t/iplimit" >> plugin.cfg
          grep -q "^takeover:" plugin.cfg || echo "takeover:github.com/Dk0n9/takeover" >> plugin.cfg
          grep -q "^blocker:" plugin.cfg || echo "blocker:github.com/icyflame/blocker" >> plugin.cfg
          grep -q "^dnsredir:" plugin.cfg || echo "dnsredir:github.com/leiless/dnsredir" >> plugin.cfg
          # unbound 已移除（兼容性太差，6年未维护）
          # grep -q "^unbound:" plugin.cfg || echo "unbound:github.com/coredns/unbound" >> plugin.cfg
          grep -q "^git:" plugin.cfg || echo "git:github.com/miekg/coredns-git" >> plugin.cfg

      - name: Generate and tidy modules
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          cd coredns-src
          go generate
          go mod tidy

      - name: Build CoreDNS for Linux arm64 (no cgo needed)
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          cd coredns-src
          go env -u GOSUMDB || true
          go env -w GOPROXY=https://goproxy.cn,direct
          go env -w GOSUMDB=sum.golang.google.cn
          # 打印 go 环境，方便排查
          go env
          # unbound 已移除，可用 CGO_ENABLED=0 保持静态二进制
          CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -o ../corednsplus

      - name: Move binary to root and update VERSION
        if: steps.check_update.outputs.update_needed == 'true'
        run: |
          # mv ../corednsplus .   # 移到仓库根目录
          echo "${{ steps.get_version.outputs.latest_version }}" > VERSION

      - name: Create or Update GitHub Release with binary
        if: steps.check_update.outputs.update_needed == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.get_version.outputs.latest_version }}
          name: CoreDNS Plus ${{ steps.get_version.outputs.latest_version }}
          files: corednsplus
          body: |
            Built with plugins: blocklist, finalize, git
            Commit: ${{ github.sha }}
            - Download `corednsplus` from assets below (arm64 Linux binary)
          draft: false
          prerelease: false
          generate_release_notes: true
